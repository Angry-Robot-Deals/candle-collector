# DEV-0001: Migrate to pnpm, update deps, modernize Docker — Implementation Plan

**Task ID:** DEV-0001  
**Complexity:** Level 2  
**Last Updated:** 2026-02-20  

---

## 1. Overview

**Problem:** Project uses npm; Dockerfile and docker-compose use npm; dependencies and Docker setup are not aligned with current pnpm and Docker documentation.

**Goals:**
- Use pnpm as the single package manager (lockfile, Docker, docs).
- Update all dependencies in `package.json` and refresh lockfile.
- Align Dockerfile and docker-compose with current pnpm Docker guide and Compose specification.
- Verify local build and server deploy.

**Success criteria:**
- `pnpm install` and `pnpm run build` succeed locally.
- Docker image builds with pnpm and runs via `pnpm run start:prod`.
- Deploy script runs successfully on server; app responds on port 14444.
- No remaining npm references in repo or Memory Bank docs.

### 1.1 LTS and version matrix (verified via context7 and official docs)

| Component | Recommended LTS / latest | Source / notes |
|-----------|-------------------------|------------------|
| **Node.js** | **24 LTS** (Krypton, Active LTS) | [nodejs.org/about/releases](https://nodejs.org/en/about/releases): v24 Active LTS; v22 Maintenance LTS. Use `node:24-alpine` in Docker for latest LTS. |
| **pnpm** | **10.x** | [pnpm.io/installation](https://pnpm.io/installation): `corepack use pnpm@latest-10`; compatibility table: Node 24 ✔️ with pnpm 8/9/10. Use `"packageManager": "pnpm@10.x.x"` (exact after lockfile). |
| **NestJS** | **11.x** (or keep 10.x) | Context7 (nestjs/docs.nestjs.com): NestJS 11 requires Node.js v20+; recommend latest LTS. Node 24 is supported. Migration 10→11 has breaking changes (Express 5, path matching); optional for this task. |
| **Prisma** | **7.x** (or keep 6.x) | Context7 (prisma/docs): latest Prisma requires Node ^20.19, ^22.12, or ^24.0. Prisma 7 is current (7.4.x); Node 24 supported. Prisma 7 has breaking changes vs 6; optional major upgrade in this task. |
| **Docker Node image** | **node:24-alpine** | Official image; 24-alpine uses Alpine 3.23. pnpm.io Docker examples use node:20-slim; we use 24-alpine for LTS + smaller image. |
| **Docker Compose** | Current Compose spec | No `version:` key; [Compose Specification](https://docs.docker.com/reference/compose-file); use `docker compose` (v2 CLI). |

**Recommendation for this task:** Use **Node 24 LTS** and **pnpm 10** in Docker and packageManager. Update NestJS and Prisma within current major (10.x, 6.x) unless we explicitly upgrade to 11 / 7 in the same change set.

---

## 2. Security Summary

- **Attack surface:** Unchanged (no new network or auth surface).
- **New permissions:** None.
- **Sensitive data:** Unchanged (.env not in image; deploy uses existing SSH/key).
- **Risks:** None beyond existing (build/deploy pipeline; no new secrets in code).

---

## 3. Architecture Impact

- **Components:** package.json, lockfile, Dockerfile, docker-compose.yml, README, memory-bank docs, deploy script (optional wording only).
- **Integration:** Local dev and CI use pnpm; Docker build/run use pnpm; server deploy unchanged (git pull + docker compose build/up).

---

## 4. Detailed Design

### 4.1 Component Changes

| File | Changes | Reason |
|------|---------|--------|
| `package.json` | Add `"packageManager": "pnpm@10.x.x"` (exact version from lockfile; pnpm 10 is current LTS-aligned). Optionally replace `npx` in scripts with `pnpm exec`. | Declare pnpm and version for Corepack/Docker (context7/pnpm.io). |
| (new) `pnpm-lock.yaml` | Generated by `pnpm install`. | Single source of truth for deps. |
| (remove) `package-lock.json` | Delete after migration. | Avoid mixing package managers. |
| `Dockerfile` | Multi-stage: base **node:24-alpine** (Node 24 LTS) + Corepack + pnpm; deps stage (copy package.json + pnpm-lock.yaml, pnpm install --frozen-lockfile); build stage (copy app, pnpm run build); production stage (copy node_modules + dist, CMD pnpm run start:prod). Use BuildKit cache mount for pnpm store. Set `ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0` for non-interactive build. | Follow pnpm.io/docker (context7); Node 24 = current Active LTS. |
| `.dockerignore` | Create: `node_modules`, `.git`, `*.md`, `dist`, `.env`, `.env.*`, `coverage`, `.idea`, etc. | Faster context and build; exclude secrets. |
| `docker-compose.yml` | Change `command` from `npm run start:prod` to `pnpm run start:prod`. Optionally add top-level `name: cc` for consistency with deploy (`-p cc`). Keep Compose spec (no version key; current format). | Use pnpm in container; align with Compose spec. |
| `README.md` | Replace `npm install` / `npx prisma generate` / `npm run …` with `pnpm install` / `pnpm exec prisma generate` / `pnpm run …`. | Doc matches tooling. |
| `memory-bank/techContext.md` | Replace npm commands with pnpm. | Doc matches tooling. |
| `memory-bank/projectbrief.md` | Replace `npm run start:dev` with `pnpm run start:dev`. | Doc matches tooling. |
| `memory-bank/style-guide.md` | Replace `npm run format` / `npm run lint` with pnpm. | Doc matches tooling. |

### 4.2 New Components

| File | Purpose | Dependencies |
|------|---------|--------------|
| `.dockerignore` | Reduce build context; exclude node_modules, .git, docs, env files. | Used by Docker build. |
| `pnpm-lock.yaml` | Lock dependency versions. | Produced by pnpm. |

### 4.3 API Changes

None.

### 4.4 Database Changes

None.

---

## 5. Security Design (Appendix A)

### 5.1 Threat Model

- **Assets:** App code, env on server (already out of repo). No new assets.
- **Threats:** No new threat vectors; build and deploy remain same path.
- **Mitigations:** .dockerignore excludes .env; deploy script unchanged; no secrets in image.

### 5.2 Security Controls Checklist

- [x] No new user input or network exposure.
- [x] .dockerignore prevents accidental .env copy into image.
- [x] Access control and secrets handling unchanged.
- [x] No hardcoded secrets in plan.

---

## 6. Implementation Steps

### Step 1: Add packageManager and generate pnpm lockfile

**Files:** `package.json`

**Actions:**
1. Add to `package.json`: `"packageManager": "pnpm@10.0.0"` (placeholder; pnpm 10 is current, see pnpm.io/installation).
2. Install pnpm locally: `corepack enable` then `corepack use pnpm@latest-10` (or `corepack prepare pnpm@10 --activate`).
3. Run `pnpm install` to generate `pnpm-lock.yaml`.
4. Update `packageManager` in package.json to the exact version from lockfile (e.g. `pnpm@10.30.1`).
5. Delete `package-lock.json`.
6. Add `pnpm-lock.yaml` to git; commit.

**Rationale:** Lockfile and packageManager must exist before Dockerfile uses them.

### Step 2: Create .dockerignore

**Files:** `.dockerignore` (new)

**Content (minimal):**
```
node_modules
.git
.gitignore
*.md
dist
.env
.env.*
coverage
.idea
.vscode
*.log
```

**Rationale:** Speeds up build and avoids copying secrets or dev-only files.

### Step 3: Rewrite Dockerfile for pnpm

**Files:** `Dockerfile`

**Design:**
- **base:** `FROM node:24-alpine` (Node 24 LTS), `ENV PNPM_HOME="/pnpm"`, `ENV PATH="$PNPM_HOME:$PATH"`, `ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0`, `RUN corepack enable`, `WORKDIR /usr/app`.
- **deps:** FROM base; COPY package.json pnpm-lock.yaml .; RUN pnpm install --frozen-lockfile (optionally `--mount=type=cache,id=pnpm,target=/pnpm/store` for BuildKit).
- **build:** FROM base; COPY . . ; RUN pnpm install --frozen-lockfile; RUN pnpm run build (prebuild runs prisma generate).
- **production:** FROM base; COPY --from=build /usr/app/node_modules /usr/app/node_modules; COPY --from=build /usr/app/dist /usr/app/dist; COPY --from=build /usr/app/package.json /usr/app/package.json; COPY prisma /usr/app/prisma (if needed at runtime); ENV NODE_ENV=production; CMD ["pnpm", "run", "start:prod"].

Ensure Prisma schema/generated client and any runtime paths (e.g. dist path) match. If `start:prod` runs `node dist/src/main`, ensure `dist` layout is copied correctly.

**Rationale:** Matches pnpm Docker docs; multi-stage keeps final image smaller; frozen-lockfile ensures reproducible builds.

### Step 4: Update docker-compose.yml

**Files:** `docker-compose.yml`

**Changes:**
- Set `command: pnpm run start:prod` (or equivalent CMD form).
- Optionally add top-level `name: cc` so `docker compose` uses project name without `-p cc` (deploy script can keep `-p cc` for compatibility).

**Rationale:** Container must run app via pnpm; Compose file stays compatible with current Compose spec.

### Step 5: Update dependencies

**Files:** `package.json`, `pnpm-lock.yaml`

**Actions:** Run `pnpm update` (or `pnpm update -r` if monorepo). Resolve any breaking changes within current major versions. Commit updated package.json and pnpm-lock.yaml.

**Rationale:** Satisfies “update all dependencies” requirement.

### Step 6: Update documentation (README and Memory Bank)

**Files:** `README.md`, `memory-bank/techContext.md`, `memory-bank/projectbrief.md`, `memory-bank/style-guide.md`

**Changes:** Replace every `npm install`, `npx …`, `npm run …` with `pnpm install`, `pnpm exec …`, `pnpm run …` as appropriate.

**Rationale:** So developers and docs describe the actual tooling.

### Step 7: Verify deploy script

**Files:** `scripts/external-deploy.sh`

**Actions:** No code change required (script uses `docker compose build` and `up`; image will be built with new Dockerfile). Optionally add a one-line comment that the image is built with pnpm.

**Rationale:** Deploy stays generic; only the image content changes.

### Step 8: Local verification

**Commands:**
```bash
pnpm install
pnpm run build
docker compose -p cc -f docker-compose.yml build
docker compose -p cc -f docker-compose.yml up -d
# Check http://localhost:14444
docker compose -p cc -f docker-compose.yml down
```

**Rationale:** Confirms local build and run before deploy.

### Step 9: Deploy verification

**Actions:** Run `pnpm run deploy` (or `bash scripts/external-deploy.sh`) and confirm on server: containers start, app responds on 14444.

**Rationale:** Confirms production path end-to-end.

---

## 7. Test Plan

- **Unit tests:** `pnpm run test` after migration (no test code changes expected).
- **Integration:** Docker build and `docker compose up`; GET / returns health.
- **Security:** No new tests; .dockerignore and no .env in image verified by review.

---

## 8. Rollback Strategy

```bash
git checkout HEAD -- package.json Dockerfile docker-compose.yml README.md memory-bank/
git checkout HEAD -- .
# Restore package-lock.json from git history if needed
npm install
```

Redeploy previous image on server if needed: `docker compose -p cc -f docker-compose.yml up -d` after reverting repo and rebuilding.

---

## 9. Validation Checklist

- [ ] `packageManager` in package.json; pnpm-lock.yaml present; package-lock.json removed.
- [ ] .dockerignore created and excludes node_modules, .git, .env, dist.
- [ ] Dockerfile multi-stage with pnpm, build succeeds.
- [ ] docker-compose.yml command uses pnpm run start:prod.
- [ ] Dependencies updated; lockfile committed.
- [ ] README and Memory Bank use pnpm only.
- [ ] `pnpm run build` succeeds locally.
- [ ] `docker compose build` and `up` succeed; app responds on 14444.
- [ ] Deploy to server succeeds; app responds on server.

---

## 10. Next Steps

- Run implementation via `/do` (Steps 1–9).
- After completion, mark DEV-0001 checklist in `memory-bank/tasks.md` and update progress.
